<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ASME B31.3 Pipe Thickness Calculator</title>

<style>
body{font-family:Arial;background:#f2f4f7}
.container{max-width:900px;margin:20px auto;background:#fff;padding:20px;border-radius:8px}
h2{text-align:center;color:#1f4e79}
label{font-weight:bold}
input,select{width:100%;padding:6px;margin:5px 0 12px}
button{padding:8px 18px;background:#1f4e79;color:#fff;border:none;cursor:pointer}
.result{background:#eef4fb;padding:12px;margin-top:15px;border-radius:6px}
.result b{color:#1f4e79}
.preview{
 background:#f8fbff;
 border:1px dashed #1f4e79;
 padding:10px;
 margin:8px 0 12px;
 font-size:13px;
}
.align{
 font-family:monospace;
 white-space:pre;
}
</style>
</head>

<body>
<div class="container">

<h2>ASME B31.3 – Pipe Thickness Calculator</h2>

<label>Material</label>
<select id="material"></select>

<label>Pipe Type</label>
<select id="pipeType"></select>

<label>NPS</label>
<select id="nps"></select>

<label>Design Pressure (bar)</label>
<input id="P" type="number">

<label>Design Temperature (°C)</label>
<input id="T" type="number">

<label>Corrosion Allowance (mm)</label>
<input id="CA" value="1.5">

<label>Mill Tolerance (%)</label>
<input id="MT" value="12.5">

<!-- PREVIEW -->
<div class="preview">
<b>Auto Picked (Preview):</b>
<div class="align">
OD  = <span id="pOD">–</span> mm
S   = <span id="pS">–</span> MPa
E   = <span id="pE">–</span>
W   = <span id="pW">–</span>
Y   = <span id="pY">–</span>
</div>
</div>

<button onclick="calculate()">Calculate Thickness</button>

<!-- FINAL AUTO PICKED -->
<div class="result" id="autoPicked" style="display:none"></div>

<!-- RESULT -->
<div class="result" id="out" style="display:none"></div>

</div>

<script>
const materialDB = JSON.parse(localStorage.getItem("materialMasterDB")) || [];
const pipeTypeDB = JSON.parse(localStorage.getItem("pipeTypeDB")) || [];
const dimDB      = JSON.parse(localStorage.getItem("pipeDimWeightDB")) || [];
const yDB        = JSON.parse(localStorage.getItem("yDB")) || [];
const wDB        = JSON.parse(localStorage.getItem("wDB")) || [];
const sDB        = JSON.parse(localStorage.getItem("stressDB")) || [];

function nearestHigher(arr,temp){
 return arr.filter(x=>x.temp>=temp).sort((a,b)=>a.temp-b.temp)[0];
}

function init(){
 material.innerHTML="";
 materialDB.forEach(m=>{
  material.innerHTML+=`<option value="${m.family}|${m.mat}|${m.grade}">${m.mat} ${m.grade}</option>`;
 });
 pipeType.innerHTML="";
 pipeTypeDB.forEach(p=>pipeType.innerHTML+=`<option value="${p.E}">${p.type}</option>`);
 updateNPS();
 updatePreview();
}

material.onchange=()=>{updateNPS();updatePreview();}
pipeType.onchange=updatePreview;
nps.onchange=updatePreview;
T.oninput=updatePreview;

function updateNPS(){
 const mat=material.value.split("|")[1];
 const list=[...new Set(dimDB.filter(d=>d.material===mat).map(d=>d.nps))];
 nps.innerHTML="<option value=''>-- Select NPS --</option>";
 list.forEach(n=>nps.innerHTML+=`<option>${n}</option>`);
}

function updatePreview(){
 if(!nps.value||!T.value){resetPreview();return;}
 const mat=material.value.split("|")[1];
 const E=Number(pipeType.value);
 const Tval=Number(T.value);
 const odRow=dimDB.find(d=>d.material===mat&&d.nps===nps.value);
 if(!odRow){resetPreview();return;}
 const Srow=nearestHigher(sDB.filter(s=>s.mat.includes(mat)),Tval);
 const Yrow=nearestHigher(yDB.filter(y=>y.mat.includes(mat)),Tval);
 const Wrow=nearestHigher(wDB.filter(w=>w.mat.includes(mat)),Tval);
 if(!Srow||!Yrow||!Wrow){resetPreview();return;}
 pOD.innerText=odRow.od.toFixed(2);
 pS.innerText=Srow.stress.toFixed(2);
 pE.innerText=E;
 pW.innerText=Wrow.W;
 pY.innerText=Yrow.Y;
}

function resetPreview(){
 pOD.innerText=pS.innerText=pE.innerText=pW.innerText=pY.innerText="–";
}

function calculate(){
 if(!nps.value){alert("Select NPS");return;}
 if(!P.value||!T.value){alert("Enter Pressure & Temperature");return;}

 const mat=material.value.split("|")[1];
 const E=Number(pipeType.value);
 const Pmpa=Number(P.value)/10;
 const Tval=Number(T.value);
 const CAval=Number(CA.value);
 const MTval=Number(MT.value)/100;

 const odRow=dimDB.find(d=>d.material===mat&&d.nps===nps.value);
 const Srow=nearestHigher(sDB.filter(s=>s.mat.includes(mat)),Tval);
 const Yrow=nearestHigher(yDB.filter(y=>y.mat.includes(mat)),Tval);
 const Wrow=nearestHigher(wDB.filter(w=>w.mat.includes(mat)),Tval);

 const t=(Pmpa*odRow.od)/(2*(Srow.stress*E*Wrow.W+Pmpa*Yrow.Y));
 const t_req=(t+CAval)/(1-MTval);

 autoPicked.style.display="block";
 autoPicked.innerHTML=`
<b>Auto Picked Values (ASME B31.3):</b>
<div class="align">
OD  = ${odRow.od.toFixed(2)} mm
S   = ${Srow.stress} MPa (at ${Srow.temp}°C)
E   = ${E}
W   = ${Wrow.W} (at ${Wrow.temp}°C)
Y   = ${Yrow.Y} (at ${Yrow.temp}°C)
</div>

<b>ASME B31.3 Thickness Formula:</b>
<div class="align">
t = (P × D) / [ 2 × (S × E × W + P × Y) ]

Required Thickness =
(t + Corrosion Allowance) / (1 − Mill Tolerance)
</div>
`;

 out.style.display="block";
 out.innerHTML=`<b>Required Minimum Thickness:</b> ${t_req.toFixed(2)} mm`;
}

init();
</script>

</body>
</html>
