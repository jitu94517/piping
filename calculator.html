<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ASME B31.3 Pipe Thickness Calculator</title>

<style>
body{font-family:Arial;background:#f2f4f7}
.container{max-width:1000px;margin:20px auto;background:#fff;padding:20px;border-radius:8px}
h2{text-align:center;color:#1f4e79}
label{font-weight:bold}
input,select{width:100%;padding:6px;margin:5px 0 12px}
button{padding:8px 18px;background:#1f4e79;color:#fff;border:none;cursor:pointer}
.result{background:#eef4fb;padding:12px;margin-top:15px;border-radius:6px}
.preview{background:#f8fbff;border:1px dashed #1f4e79;padding:10px;margin:10px 0}
.align{font-family:monospace;white-space:pre}
.warn{background:#fdecea;padding:10px;border-left:4px solid #c62828;margin-top:10px}
</style>
</head>

<body>
<div class="container">

<h2>ASME B31.3 – Pipe Thickness Calculator</h2>

<label>Material</label>
<select id="material"></select>

<label>Pipe Type</label>
<select id="pipeType"></select>

<label>NPS</label>
<select id="nps"></select>

<label>Design Pressure (bar)</label>
<input id="P" type="number">

<label>Design Temperature (°C)</label>
<input id="T" type="number">

<label>Corrosion Allowance (mm)</label>
<input id="CA" value="1.5">

<label>Mill Tolerance (%)</label>
<input id="MT" value="12.5">

<div class="preview">
<b>Auto Picked (Preview):</b>
<div class="align">
OD = <span id="pOD">–</span> mm
S  = <span id="pS">–</span> MPa
E  = <span id="pE">–</span>
W  = <span id="pW">–</span>
Y  = <span id="pY">–</span>
</div>
</div>

<button onclick="calculate()">Calculate Thickness</button>

<div class="result" id="out" style="display:none"></div>
<div class="warn" id="warnBox" style="display:none"></div>

</div>

<script>
/* ===== LOAD DATABASE ===== */
const materialDB = JSON.parse(localStorage.getItem("materialMasterDB")) || [];
const pipeTypeDB = JSON.parse(localStorage.getItem("pipeTypeDB")) || [];
const dimDB = JSON.parse(localStorage.getItem("pipeDimWeightDB")) || [];
const yDB = JSON.parse(localStorage.getItem("yDB")) || [];
const wDB = JSON.parse(localStorage.getItem("wDB")) || [];
const sDB = JSON.parse(localStorage.getItem("stressDB")) || [];

/* ===== HELPERS ===== */
const nearestHigherTemp=(arr,t)=>arr.filter(x=>x.temp>=t).sort((a,b)=>a.temp-b.temp)[0];
const nearestHigherThickness=(arr,t)=>arr.filter(x=>x>=t).sort((a,b)=>a-b)[0];

/* ===== INIT ===== */
function init(){
 material.innerHTML="";
 materialDB.forEach(m=>{
  material.innerHTML+=`
   <option value="${m.family}|${m.mat}|${m.grade}">
    ${m.family} | ${m.mat} | ${m.grade}
   </option>`;
 });

 pipeType.innerHTML="";
 pipeTypeDB.forEach(p=>{
  pipeType.innerHTML+=`<option value="${p.E}">${p.type}</option>`;
 });

 updateNPS();
}
material.onchange=updateNPS;

function updateNPS(){
 const [family,mat,grade]=material.value.split("|");
 const list=[...new Set(
  dimDB.filter(d=>d.family===family && d.material===mat && d.grade===grade)
       .map(d=>d.nps)
 )];
 nps.innerHTML="<option value=''>-- Select NPS --</option>";
 list.forEach(n=>nps.innerHTML+=`<option>${n}</option>`);
}

/* ===== CALCULATE ===== */
function calculate(){
 warnBox.style.display="none";
 out.style.display="none";

 if(!nps.value||!P.value||!T.value){
  alert("Please fill mandatory inputs");
  return;
 }

 const [family,mat,grade]=material.value.split("|");
 const E=+pipeType.value;
 const Pmpa=+P.value/10;
 const Tval=+T.value;
 const CAval=+CA.value;
 const MTval=+MT.value/100;

 const avail=dimDB.filter(d=>
  d.family===family &&
  d.material===mat &&
  d.grade===grade &&
  d.nps===nps.value
 );

 const odRow=avail[0];
 const Srow=nearestHigherTemp(
  sDB.filter(s=>s.mat.includes(grade)),Tval);
 const Yrow=nearestHigherTemp(
  yDB.filter(y=>y.mat.includes(mat)),Tval);
 const Wrow=nearestHigherTemp(
  wDB.filter(w=>w.mat.includes(mat)),Tval);

 if(!odRow||!Srow||!Yrow||!Wrow){
  alert("Required data missing in admin master");
  return;
 }

 const t=(Pmpa*odRow.od)/(2*(Srow.stress*E*Wrow.W+Pmpa*Yrow.Y));
 const t_req=(t+CAval)/(1-MTval);

 const t2=nearestHigherThickness(
  avail.map(d=>d.thickness),t_req
 );

 if(!t2){
  warnBox.style.display="block";
  warnBox.innerHTML=
   `⚠ Calculated thickness (${t_req.toFixed(2)} mm) exceeds available thickness range for selected NPS.`;
  return;
 }

 out.style.display="block";
 out.innerHTML=`
 <b>Calculated Minimum Thickness:</b> ${t_req.toFixed(2)} mm<br><br>
 <b>Nearest Higher Standard Thickness:</b> ${t2} mm
 `;
}
init();
</script>

</body>
</html>
