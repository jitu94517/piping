<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ASME B31.3 Pipe Thickness Calculator</title>

<style>
body{font-family:Arial;background:#f2f4f7}
.container{max-width:900px;margin:20px auto;background:#fff;padding:20px;border-radius:8px}
h2{text-align:center;color:#1f4e79}
label{font-weight:bold}
input,select{width:100%;padding:6px;margin:5px 0 12px}
button{padding:8px 18px;background:#1f4e79;color:#fff;border:none;cursor:pointer}
.result{background:#eef4fb;padding:10px;margin-top:15px;border-radius:6px}
.result b{color:#1f4e79}
.preview{
 background:#f8fbff;
 border:1px dashed #1f4e79;
 padding:8px;
 margin:8px 0 12px;
 font-size:13px;
}
hr{margin:20px 0}
</style>
</head>

<body>
<div class="container">

<h2>ASME B31.3 – Pipe Thickness Calculator</h2>

<!-- ================= USER INPUT ================= -->

<label>Material</label>
<select id="material"></select>

<label>Pipe Type</label>
<select id="pipeType"></select>

<label>NPS</label>
<select id="nps"></select>

<label>Design Pressure (bar)</label>
<input id="P" type="number">

<label>Design Temperature (°C)</label>
<input id="T" type="number">

<label>Corrosion Allowance (mm)</label>
<input id="CA" value="1.5">

<label>Mill Tolerance (%)</label>
<input id="MT" value="12.5">

<!-- ===== AUTO PICKED PREVIEW (ALWAYS BEFORE CALCULATE) ===== -->
<div class="preview" id="previewBox">
<b>Auto Picked (Preview):</b><br>
OD = <span id="pOD">–</span> mm |
S = <span id="pS">–</span> MPa |
E = <span id="pE">–</span> |
W = <span id="pW">–</span> |
Y = <span id="pY">–</span>
</div>

<button onclick="calculate()">Calculate Thickness</button>

<!-- ================= AUTO PICKED VALUES (DETAIL) ================= -->
<div class="result" id="autoPicked" style="display:none">
 <b>Auto Picked Values (ASME B31.3):</b><br><br>
 Outside Diameter, OD = <span id="odVal"></span> mm<br>
 Allowable Stress, S = <span id="sVal"></span> MPa<br>
 Quality Factor, E = <span id="eVal"></span><br>
 Weld Strength Reduction Factor, W = <span id="wVal"></span><br>
 Y Factor = <span id="yVal"></span>
</div>

<!-- ================= FINAL OUTPUT ================= -->
<div class="result" id="out" style="display:none"></div>

</div>

<script>
/* ================= LOAD DATABASES ================= */
const materialDB = JSON.parse(localStorage.getItem("materialMasterDB")) || [];
const pipeTypeDB = JSON.parse(localStorage.getItem("pipeTypeDB")) || [];
const dimDB      = JSON.parse(localStorage.getItem("pipeDimWeightDB")) || [];
const yDB        = JSON.parse(localStorage.getItem("yDB")) || [];
const wDB        = JSON.parse(localStorage.getItem("wDB")) || [];
const sDB        = JSON.parse(localStorage.getItem("stressDB")) || [];

/* ================= INIT ================= */
function init(){

 material.innerHTML="";
 materialDB.forEach(m=>{
  material.innerHTML+=`
   <option value="${m.family}|${m.mat}|${m.grade}">
    ${m.mat} ${m.grade}
   </option>`;
 });

 pipeType.innerHTML="";
 pipeTypeDB.forEach(p=>{
  pipeType.innerHTML+=`<option value="${p.E}">${p.type}</option>`;
 });

 updateNPS();
 updatePreview();
}

material.onchange = ()=>{ updateNPS(); updatePreview(); };
pipeType.onchange = updatePreview;
nps.onchange = updatePreview;
T.oninput = updatePreview;

/* ================= UPDATE NPS ================= */
function updateNPS(){
 const mat = material.value.split("|")[1];
 const list = [...new Set(
  dimDB.filter(d=>d.material===mat).map(d=>d.nps)
 )];
 nps.innerHTML="<option value=''>-- Select NPS --</option>";
 list.forEach(n=>nps.innerHTML+=`<option>${n}</option>`);
}

/* ================= PREVIEW (NO CALCULATION) ================= */
function updatePreview(){

 if(!nps.value){ resetPreview(); return; }

 const [_,mat] = material.value.split("|");
 const E = Number(pipeType.value);
 const Tval = Number(T.value);

 const odRow = dimDB.find(d=>d.material===mat && d.nps===nps.value);
 if(!odRow){ resetPreview(); return; }

 const S = sDB.filter(s=>s.mat.includes(mat))
  .sort((a,b)=>b.temp-a.temp)
  .find(s=>Tval>=s.temp)?.stress;

 const Y = yDB.filter(y=>y.mat.includes(mat))
  .sort((a,b)=>b.temp-a.temp)
  .find(y=>Tval>=y.temp)?.Y;

 const W = wDB.filter(w=>w.mat.includes(mat))
  .sort((a,b)=>b.temp-a.temp)
  .find(w=>Tval>=w.temp)?.W;

 if(S===undefined || Y===undefined || W===undefined){
  resetPreview(); return;
 }

 pOD.innerText = odRow.od.toFixed(2);
 pS.innerText  = S.toFixed(2);
 pE.innerText  = E;
 pW.innerText  = W;
 pY.innerText  = Y;
}

function resetPreview(){
 pOD.innerText = pS.innerText = pE.innerText =
 pW.innerText = pY.innerText = "–";
}

/* ================= HELPER ================= */
function nearestHigher(arr,val){
 return arr.filter(x=>x>=val).sort((a,b)=>a-b)[0];
}

/* ================= CALCULATION ================= */
function calculate(){

 if(!nps.value){
  alert("⚠ Please select NPS before calculation");
  return;
 }
 if(!P.value || !T.value){
  alert("⚠ Please enter Design Pressure and Temperature");
  return;
 }

 const [_,mat] = material.value.split("|");
 const E = Number(pipeType.value);
 const Pmpa = Number(P.value)/10;
 const Tval = Number(T.value);
 const CAval = Number(CA.value);
 const MTval = Number(MT.value)/100;

 const odRow = dimDB.find(d=>d.material===mat && d.nps===nps.value);
 if(!odRow){ alert("OD not found"); return; }

 const S = sDB.filter(s=>s.mat.includes(mat))
  .sort((a,b)=>b.temp-a.temp)
  .find(s=>Tval>=s.temp)?.stress;

 const Y = yDB.filter(y=>y.mat.includes(mat))
  .sort((a,b)=>b.temp-a.temp)
  .find(y=>Tval>=y.temp)?.Y;

 const W = wDB.filter(w=>w.mat.includes(mat))
  .sort((a,b)=>b.temp-a.temp)
  .find(w=>Tval>=w.temp)?.W;

 if(S===undefined||Y===undefined||W===undefined){
  alert("Required design data not found");
  return;
 }

 const t = (Pmpa*odRow.od)/(2*(S*E*W + Pmpa*Y));
 const t_req = (t + CAval)/(1-MTval);

 const thkList = dimDB
  .filter(d=>d.material===mat && d.nps===nps.value)
  .map(d=>d.thickness);

 const thk2 = nearestHigher(thkList,t_req);
 if(!thk2){ alert("No suitable thickness found"); return; }

 const sel = dimDB.find(d=>d.material===mat && d.nps===nps.value && d.thickness===thk2);
 const sch = sel.schedule || "NON-SCHEDULE";

 /* ===== SHOW AUTO PICKED DETAIL ===== */
 autoPicked.style.display="block";
 odVal.innerText = odRow.od.toFixed(2);
 sVal.innerText  = S.toFixed(2);
 eVal.innerText  = E;
 wVal.innerText  = W;
 yVal.innerText  = Y;

 /* ===== FINAL OUTPUT ===== */
 out.style.display="block";
 out.innerHTML=`
 <b>Calculated Minimum Thickness (incl. CA & Mill Tolerance):</b>
 ${t_req.toFixed(2)} mm<br><br>

 <b>Nearest Higher Thickness from Standard Table:</b>
 ${thk2} mm<br><br>

 <b>Suggested Thickness for Piping System:</b>
 ${thk2} mm (${sch})
 `;
}

init();
</script>

</body>
</html>
